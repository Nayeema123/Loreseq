#script for LRS pipeline
#bin/bash
#paths

#paths

#conda activate lrs_env

#Step:1 - Quality check

#echo "Nanoplot is running..."
#NanoPlot --fastq /home/nayeema/LRS/data/ERR3279035.fastq --outdir /home/nayeema/LRS/results


#Step 2:filtering low quality reads
#echo "filtering low quality reads using filtlong..."
#filtlong --min_length 1000 --min_mean_q 20 --keep_percent 90 /home/nayeema/LRS/data/ERR3279035.fastq > /home/nayeema/LRS/results/ERR3279035_filtered.fastq
#echo "filtlong completed....."

#Step:3
#echo " nanoplot for filtered reads..."
#NanoPlot --fastq /home/nayeema/LRS/results/ERR3279035_filtered.fastq --outdir /home/nayeema/LRS/results/filtered_quality/filtered_quality.fastq

#step :3
#Alignment to hg38.fa using minimap2
#minimap2 -t 4 -d hg38.mmi hg38.fa
#echo "Aligning reads to ref genome...."
#minimap2 -ax map-ont -t 4 /home/nayeema/LRS/hg38/hg38.mmi /home/nayeema/LRS/results/ERR3279035_filtered.fastq > /home/nayeema/LRS/results/ERR3279035.sam
#echo " Aligning finished..."


#step :4 - convert sam to bam
#echo "Converting sam to bam format..."
#samtools view -@ 4 -b /home/nayeema/LRS/results/ERR3279035.sam > /home/nayeema/LRS/aligned_reads/ERR3279035_aligned.bam
#echo "converting sam to bam finished...."

#echo "sorting bam file..."
#samtools sort -@ 4 /home/nayeema/LRS/aligned_reads/ERR3279035_aligned.bam -o /home/nayeema/LRS/aligned_reads/ERR3279035_sorted.bam
#echo " Sorting completed"

#echo "Indexing sorted bam..."
#samtools index /home/nayeema/LRS/aligned_reads/ERR3279035_sorted.bam
#echo "Indexig completed..."

#Step: 5
#variant calling using bcftools,,cuteSV,Sniffles,longshot
#echo "calling structural variants using cuteSv..."
#cuteSV /home/nayeema/LRS/aligned_reads/ERR3279035_sorted.bam /home/nayeema/LRS/hg38/hg38.fa /home/nayeema/LRS/variants/cutesv.vcf /home/nayeema/LRS/variants/cutesv_tmp --threads 4
#echo " Cutesv completed.."

echo "variant calling using bcftools.."
# Generate BCF (binary variant call format)
bcftools mpileup --threads 4 -Ou -f /home/nayeema/LRS/hg38/hg38.fa /home/nayeema/LRS/aligned_reads/ERR3279035_sorted.bam | \
bcftools call --threads 4 -mv -Ob -o /home/nayeema/LRS/variants/ERR3279035.bcf

# Convert BCF to VCF
echo "converting bcf to vcf....."
bcftools view /home/nayeema/LRS/variants/ERR3279035.bcf > /home/nayeema/LRS/variants/ERR3279035_bcf.vcf
echo "Converting  bcf to vcf finished.."

echo "Calling variants using Longshot..."
longshot --bam /home/nayeema/LRS/aligned_reads/ERR3279035_sorted.bam \
         --ref /home/nayeema/LRS/hg38/hg38.fa \
         --out /home/nayeema/LRS/variants/ERR3279035_longshot.vcf \
         --num_threads 4
echo "Longshot variant calling completed."

echo "Calling variants using FreeBayes..."
freebayes -f /home/nayeema/LRS/hg38/hg38.fa \
          /home/nayeema/LRS/aligned_reads/ERR3279035_sorted.bam > \
          /home/nayeema/LRS/variants/ERR3279035_freebayes.vcf
echo "FreeBayes variant calling completed."

echo "Calling variants using Clair3..."
bash /home/nayeema/LRS/tools/clair3/run_clair3.sh \
    --bam_fn /home/nayeema/LRS/aligned_reads/ERR3279035_sorted.bam \
    --ref_fn /home/nayeema/LRS/hg38/hg38.fa \
    --threads 4 \
    --platform ont \
    --model_path ~/clair3_models/ont \
    --output /home/nayeema/LRS/variants/clair3_output
echo "Clair3 variant calling completed."


 Step 5: Consensus Calling

# Count of variants
awk '!/^#/' /home/nayeema/LRS/variants/ERR3279035_bcf.vcf | wc -l  # bcftools
awk '!/^#/' /home/nayeema/LRS/variants/cutesv.vcf | wc -l       # cuteSV
awk '!/^#/' /home/nayeema/LRS/variants/sniffles.vcf | wc -l     # Sniffles
awk '!/^#/' /home/nayeema/LRS/variants/clair3_output/merge_output.vcf | wc -l  # Clair3

# Comparing variant positions in Clair3 and bcftools
bcftools view -H /home/nayeema/LRS/variants/ERR3279035_bcf.vcf | \
awk 'NR==FNR {a[$1$2]; next} ($1$2) in a' - \
<(bcftools view -H /home/nayeema/LRS/variants/clair3_output/merge_output.vcf) > /home/nayeema/LRS/variants/clair_bcf_pos_overlap.vcf

echo "Number of shared loci (Clair3 vs BCFtools):"
awk '!/^#/' /home/nayeema/LRS/variants/clair_bcf_pos_overlap.vcf | wc -l

# Find common ALT alleles
awk 'NR==FNR {a[$5]; next} $5 in a' /home/nayeema/LRS/variants/ERR3279035_bcf.vcf \
/home/nayeema/LRS/variants/clair_bcf_pos_overlap.vcf > /home/nayeema/LRS/variants/consensus_clair_bcf.vcf

# Count common ALT alleles
echo "Common ALT alleles (Clair3 vs BCFtools):"
awk '!/^#/' /home/nayeema/LRS/variants/consensus_clair_bcf.vcf | wc -l

# Compare with cuteSV
awk 'NR==FNR {a[$1$2]; next} ($1$2) in a' /home/nayeema/LRS/variants/cutesv.vcf \
/home/nayeema/LRS/variants/consensus_clair_bcf.vcf > /home/nayeema/LRS/variants/pos_overlap_cute_clairbcf.vcf

awk '!/^#/' /home/nayeema/LRS/variants/pos_overlap_cute_clairbcf.vcf | wc -l

# Common ALT alleles among cuteSV, Clair3, and bcftools
awk 'NR==FNR {a[$5]; next} $5 in a' /home/nayeema/LRS/variants/cutesv.vcf \
/home/nayeema/LRS/variants/pos_overlap_cute_clairbcf.vcf > /home/nayeema/LRS/variants/consensus_clair_bcf_cute.vcf

echo "Common ALT alleles (Clair3, BCFtools, CuteSV):"
awk '!/^#/' /home/nayeema/LRS/variants/consensus_clair_bcf_cute.vcf | wc -l

# Step 6: Overlap with ClinVar
bedtools intersect -wa -wb \
-a /home/nayeema/LRS/annotations/bcftools_variants_no_chr.bed \
-b /home/nayeema/LRS/annotations/clinvar_20250323.bed > /home/nayeema/LRS/annotations/bcf_clinvar_overlap.bed

awk '{
    if ($9 == "Pathogenic") pathogenic++;
    else if ($9 == "Likely_pathogenic") likely_pathogenic++;
    else if ($9 == "Benign") benign++;
    else if ($9 == "Likely_benign") likely_benign++;
    else if ($9 == "Uncertain_significance") vus++;
}
END {
    print "Pathogenic: " pathogenic;
    print "Likely Pathogenic: " likely_pathogenic;
    print "Benign: " benign;
    print "Likely Benign: " likely_benign;
    print "Uncertain Significance (VUS): " vus;
}' /home/nayeema/LRS/annotations/bcf_clinvar_overlap.bed

# Clair3 overlap with ClinVar
bedtools intersect -wa -wb \
-a /home/nayeema/LRS/annotations/clair_variants_no_chr.bed \
-b /home/nayeema/LRS/annotations/clinvar_20250323.bed > /home/nayeema/LRS/annotations/clair_clinvar_overlap.bed

awk '{
    if ($9 == "Pathogenic") pathogenic++;
    else if ($9 == "Likely_pathogenic") likely_pathogenic++;
    else if ($9 == "Benign") benign++;
    else if ($9 == "Likely_benign") likely_benign++;
    else if ($9 == "Uncertain_significance") vus++;
}
END {
    print "Pathogenic: " pathogenic;
    print "Likely Pathogenic: " likely_pathogenic;
    print "Benign: " benign;
    print "Likely Benign: " likely_benign;
    print "Uncertain Significance (VUS): " vus;
}' /home/nayeema/LRS/annotations/clair_clinvar_overlap.bed

# Step 8: dbVar overlap with BCFtools
bedtools intersect -a /home/nayeema/LRS/annotations/dbVar.bed \
-b /home/nayeema/LRS/annotations/bcftools_variants_no_chr.bed > /home/nayeema/LRS/annotations/dbvar_bcftools_overlap.bed

# Step 9: dbVar overlap with Clair3
bedtools intersect -a /home/nayeema/LRS/annotations/dbVar.bed \
-b /home/nayeema/LRS/annotations/clair_variants_no_chr.bed > /home/nayeema/LRS/annotations/dbvar_clair_overlap.bed

